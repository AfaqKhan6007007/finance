<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if is_edit %}Edit{% else %}New{% endif %} Tax Withholding Category</title>
    
    <style>
        /* --- Base Styles from your TaxRule Form --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background-color: #f9fafb; color: #333; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 32px 24px; margin-left: 250px; /* Adjust based on sidebar */ }
        
        .form-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 40px; margin-bottom: 24px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px 32px; }
        .form-group { margin-bottom: 0; }
        .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #374151; }
        .required::after { content: " *"; color: #dc2626; }
        
        .form-control, .form-select { 
            width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; 
            background-color: #fff;
        }
        .form-control:focus, .form-select:focus { outline: none; border-color: #00a896; box-shadow: 0 0 0 3px rgba(0,168,150,0.1); }
        
        /* Checkbox styling */
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .form-check-input { width: 18px; height: 18px; accent-color: #00a896; cursor: pointer; }
        
        /* --- Inline Table Styles (Specific to this complex form) --- */
        .section-title { font-size: 18px; font-weight: 700; color: #1f2937; margin: 32px 0 16px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
        
        .inline-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .inline-table th { text-align: left; padding: 12px; background-color: #f3f4f6; color: #00a896; font-weight: 600; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
        .inline-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        
        /* Small inputs for tables */
        .inline-table .form-control { padding: 6px 8px; font-size: 13px; }
        
        .btn-add-row { background: none; border: 1px dashed #d1d5db; color: #6b7280; width: 100%; padding: 8px; margin-top: 8px; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: 500; }
        .btn-add-row:hover { border-color: #00a896; color: #00a896; background-color: #f0fdfa; }

        .btn-save { margin-top: 32px; padding: 12px 32px; background-color: #00a896; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 15px; }
        .btn-save:hover { background-color: #008c7a; }
        
        .delete-check { display: flex; align-items: center; justify-content: center; height: 38px; }
        
        /* Error handling */
        .errorlist { list-style: none; color: #dc2626; font-size: 12px; margin-top: 4px; padding: 0; }

        .django-delete-checkbox {
    display: none !important;
}

/* Style the trash button */
.btn-delete-row {
    background: none;
    border: none;
    cursor: pointer;
    color: #dc2626; /* Red */
    font-size: 1.2rem;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.2s;
}

.btn-delete-row:hover {
    background-color: #fee2e2;
}

/* Style for rows marked for deletion */
.row-deleted {
    display: none;
}
    </style>
</head>

<body>
{% include "finance/header.html" %}
{% include "finance/sidenav_tax.html" %}

<div class="main-content">
    <h2 style="margin-bottom: 24px; color: #111827;">
        {% if is_edit %}Edit{% else %}New{% endif %} Tax Withholding Category
    </h2>

    <form method="post">
        {% csrf_token %}
        
        <div class="form-card">
            <h3 class="section-title" style="margin-top: 0;">Category Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Name</label>
                    {{ form.name }}
                    {{ form.name.errors }}
                </div>

                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    {{ form.category_name }}
                    {{ form.category_name.errors }}
                </div>

                <div class="form-group">
                    <label class="form-label required">Deduct Tax On Basis</label>
                    {{ form.deduct_tax_on_basis }}
                </div>

                <div class="form-group">
                    <label class="form-label">Section</label>
                    {{ form.section }}
                </div>

                <div class="form-group">
                    <label class="form-label">Entity</label>
                    {{ form.entity }}
                </div>
            </div>

            <div class="form-grid" style="margin-top: 24px;">
                <div class="checkbox-column">
                    <div class="checkbox-wrapper">
                        {{ form.round_off_tax_amount }}
                        <label class="form-label" style="margin:0;">Round Off Tax Amount</label>
                    </div>
                    <div class="checkbox-wrapper">
                        {{ form.only_deduct_on_excess }}
                        <label class="form-label" style="margin:0;">Only Deduct Tax On Excess Amount</label>
                    </div>
                </div>
                <div class="checkbox-column">
                    <div class="checkbox-wrapper">
                        {{ form.disable_cumulative_threshold }}
                        <label class="form-label" style="margin:0;">Disable Cumulative Threshold</label>
                    </div>
                    <div class="checkbox-wrapper">
                        {{ form.disable_transaction_threshold }}
                        <label class="form-label" style="margin:0;">Disable Transaction Threshold</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-card">
            <h3 class="section-title">Tax Withholding Rates</h3>
            {{ rates_formset.management_form }}
            
            <table class="inline-table" id="rates-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">From Date</th>
                        <th style="width: 15%;">To Date</th>
                        <th style="width: 15%;">Tax Withholding Group</th>
                        <th style="width: 10%;">Tax Withholding Rate</th>
                        <th style="width: 15%;">Cum. Threshold</th>
                        <th style="width: 15%;">Trans. Threshold</th>
                        <th style="width: 5%; text-align:center;">ðŸ—‘</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in rates_formset %}
                        <tr class="rates-form-row">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            <td>{{ form.from_date }} {{ form.from_date.errors }}</td>
                            <td>{{ form.to_date }} {{ form.to_date.errors }}</td>
                            <td>{{ form.tax_withholding_group }}</td>
                            <td>{{ form.tax_withholding_rate }}</td>
                            <td>{{ form.cumulative_threshold }}</td>
                            <td>{{ form.transaction_threshold }}</td>
                            <td style="text-align: center;">
                                {% if rates_formset.can_delete %}
                                    <span class="django-delete-checkbox">{{ form.DELETE }}</span>
                                    <button type="button" class="btn-delete-row" title="Delete this row">ðŸ—‘</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="rates-empty-form" style="display:none;">
                <table>
                    <tr class="rates-form-row">
                        <td>{{ rates_formset.empty_form.from_date }}</td>
                        <td>{{ rates_formset.empty_form.to_date }}</td>
                        <td>{{ rates_formset.empty_form.tax_withholding_group }}</td>
                        <td>{{ rates_formset.empty_form.tax_withholding_rate }}</td>
                        <td>{{ rates_formset.empty_form.cumulative_threshold }}</td>
                        <td>{{ rates_formset.empty_form.transaction_threshold }}</td>
                        <td style="text-align: center;">
                            <span class="django-delete-checkbox">{{ rates_formset.empty_form.DELETE }}</span>
                            <button type="button" class="btn-delete-row" title="Delete this row">ðŸ—‘</button>
                        </td>
                    </tr>
                </table>
            </div>
            
            <button type="button" class="btn-add-row" id="add-rate-btn">+ Add Rate Row</button>
        </div>

        <div class="form-card">
            <h3 class="section-title">Account Details</h3>
            {{ accounts_formset.management_form }}
            
            <table class="inline-table" id="accounts-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Company</th>
                        <th style="width: 40%;">Account</th>
                        <th style="width: 10%; text-align:center;">ðŸ—‘</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in accounts_formset %}
                        <tr class="accounts-form-row">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            <td>{{ form.company }} {{ form.company.errors }}</td>
                            <td>{{ form.account }} {{ form.account.errors }}</td>
                            <td style="text-align: center;">
                                {% if accounts_formset.can_delete %}
                                    <span class="django-delete-checkbox">{{ form.DELETE }}</span>
                                    <button type="button" class="btn-delete-row" title="Delete this row">ðŸ—‘</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
             <div id="accounts-empty-form" style="display:none;">
                <table>
                    <tr class="accounts-form-row">
                        <td>{{ accounts_formset.empty_form.company }}</td>
                        <td>{{ accounts_formset.empty_form.account }}</td>
                        <td style="text-align: center;">
                            <span class="django-delete-checkbox">{{ accounts_formset.empty_form.DELETE }}</span>
                            <button type="button" class="btn-delete-row" title="Delete this row">ðŸ—‘</button>
                        </td>
                    </tr>
                </table>
            </div>

            <button type="button" class="btn-add-row" id="add-account-btn">+ Add Account Row</button>
        </div>

        <button type="submit" class="btn-save">Save Category</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Logic for Adding Rows ---
        function addFormRow(prefix, btnId, tableId, emptyFormId) {
            const btn = document.getElementById(btnId);
            const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            
            if (btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    let formCount = parseInt(totalForms.value);
                    const emptyFormDiv = document.getElementById(emptyFormId);
                    const emptyRow = emptyFormDiv.getElementsByTagName('tr')[0].cloneNode(true);
                    
                    // Replace __prefix__ with the new index
                    const regex = new RegExp('__prefix__', 'g');
                    emptyRow.innerHTML = emptyRow.innerHTML.replace(regex, formCount);
                    
                    table.appendChild(emptyRow);
                    totalForms.value = formCount + 1;
                });
            }
        }

        // --- 2. Logic for Deleting Rows ---
        function initDeleteHandlers(tableId) {
            const table = document.getElementById(tableId);
            
            table.addEventListener('click', function(e) {
                // Check if the clicked element is our delete button
                if (e.target && e.target.closest('.btn-delete-row')) {
                    e.preventDefault();
                    const row = e.target.closest('tr');
                    
                    // Find the hidden DELETE checkbox inside this row
                    const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    
                    // Find the hidden ID input (to check if this is a saved row or a new one)
                    const idInput = row.querySelector('input[type="hidden"][name$="-id"]');
                    
                    if (idInput && idInput.value) {
                        // SCENARIO A: Existing Row (has an ID)
                        // We must check the checkbox and hide the row visually
                        if (deleteCheckbox) {
                            deleteCheckbox.checked = true;
                            row.style.display = 'none'; // Visual hide
                            row.classList.add('row-deleted'); // Tag for styling
                        }
                    } else {
                        // SCENARIO B: New Row (no ID yet)
                        // We can safely remove it from DOM entirely
                        row.remove();
                        // Optional: Decrement TOTAL_FORMS, but Django handles gaps fine
                    }
                }
            });
        }

        // Initialize Add Functionality
        addFormRow('rates', 'add-rate-btn', 'rates-table', 'rates-empty-form');
        addFormRow('accounts', 'add-account-btn', 'accounts-table', 'accounts-empty-form');

        // Initialize Delete Functionality
        initDeleteHandlers('rates-table');
        initDeleteHandlers('accounts-table');
    });
    
</script>

</body>
</html>